---
title: "NHANES Data Analysis - Combined Overview"
author: "STAT Capstone Project"
date: "`r Sys.Date()`"
output:
  html_notebook:
    toc: true
    toc_float: true
    code_folding: show
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.width = 10,
  fig.height = 6
)
```

```{r load-packages}
library(haven)
library(dplyr)
library(ggplot2)
```

# Data Loading

```{r load-all-data}
dr1iff <- read_xpt("/Users/shivpatel/Downloads/DBQ_L (1).xpt")
paq <- read_xpt('/Users/shivpatel/Downloads/PAQ_L (2).xpt')
dbq <- read_xpt('/Users/shivpatel/Downloads/DBQ_L (1).xpt')



cat("DR1IFF: ", nrow(dr1iff), " rows, ", ncol(dr1iff), " columns\n")
cat("PAQ: ", nrow(paq), " rows, ", ncol(paq), " columns\n")
cat("DBQ: ", nrow(dbq), " rows, ", ncol(dbq), " columns\n")
```

# Dataset 1: DR1IFF - Dietary Interview Day 1

## Variables Overview

```{r dr1iff-variables}
cat("Total variables:", ncol(dr1iff), "\n")
cat("Key variables:\n")
cat("  - SEQN: Respondent ID\n")
cat("  - DR1IKCAL: Calories (kcal)\n")
cat("  - DR1IPROT: Protein (g)\n")
cat("  - DR1ICARB: Carbohydrates (g)\n")
cat("  - DR1ITFAT: Total Fat (g)\n")
cat("  - DR1ISUGR: Total Sugars (g)\n")
cat("  - DR1IFIBE: Dietary Fiber (g)\n")
cat("  - DR1ICHOL: Cholesterol (mg)\n")
```
```{r}
library(haven)
library(dplyr)
library(tidyr)

dr1iff_data 


key_var_names <- data.frame(
  variable = c("SEQN", "WTDRD1", "WTDR2D", "DR1ILINE", "DR1DRSTZ", "DR1EXMER", 
               "DRABF", "DRDINT", "DR1DBIH", "DR1DAY", "DR1LANG", "DR1CCMNM", 
               "DR1CCMTX", "DR1_020", "DR1_030Z", "DR1FS", "DR1_040Z", "DR1IFDCD",
               "DR1IGRMS", "DR1IKCAL", "DR1IPROT", "DR1ICARB", "DR1ISUGR", "DR1IFIBE",
               "DR1ITFAT", "DR1ISFAT", "DR1IMFAT", "DR1IPFAT", "DR1ICHOL", "DR1IATOC",
               "DR1IATOA", "DR1IRET", "DR1IVARA", "DR1IACAR", "DR1IBCAR", "DR1ICRYP",
               "DR1ILYCO", "DR1IVB1", "DR1IVB2", "DR1INIAC", "DR1IVB6", "DR1IFOLA",
               "DR1IVB12", "DR1IVC", "DR1IVD", "DR1IVK", "DR1ICALC", "DR1IPHOS",
               "DR1IMAGN", "DR1IIRON", "DR1IZINC", "DR1ICOPP", "DR1ISODI", "DR1IPOTA",
               "DR1ISELE", "DR1ICAFF", "DR1ITHEO", "DR1IALCO"),
  description = c(
    "Respondent sequence number",
    "Dietary day one sample weight",
    "Dietary two-day sample weight",
    "Food/Individual component number",
    "Dietary recall status",
    "Interviewer ID code",
    "Breast-fed infant (either day)",
    "Number of days of intake",
    "Days between intake and HH interview",
    "Day of week of intake",
    "Language of interview",
    "Combination food number",
    "Combination food type",
    "Time of first eating occasion",
    "Time of first eating occasion (minutes)",
    "Food source",
    "Time of eating occasion (minutes)",
    "Food code",
    "Amount consumed (grams)",
    "Energy (kcal)",
    "Protein (g)",
    "Carbohydrates (g)",
    "Total sugars (g)",
    "Dietary fiber (g)",
    "Total fat (g)",
    "Saturated fatty acids (g)",
    "Monounsaturated fatty acids (g)",
    "Polyunsaturated fatty acids (g)",
    "Cholesterol (mg)",
    "Vitamin E as alpha-tocopherol (mg)",
    "Vitamin E as added alpha-tocopherol (mg)",
    "Retinol (mcg)",
    "Vitamin A, RAE (mcg)",
    "Alpha-carotene (mcg)",
    "Beta-carotene (mcg)",
    "Beta-cryptoxanthin (mcg)",
    "Lycopene (mcg)",
    "Thiamin (Vitamin B1) (mg)",
    "Riboflavin (Vitamin B2) (mg)",
    "Niacin (mg)",
    "Vitamin B6 (mg)",
    "Folate, DFE (mcg)",
    "Vitamin B12 (mcg)",
    "Vitamin C (mg)",
    "Vitamin D (mcg)",
    "Vitamin K (mcg)",
    "Calcium (mg)",
    "Phosphorus (mg)",
    "Magnesium (mg)",
    "Iron (mg)",
    "Zinc (mg)",
    "Copper (mg)",
    "Sodium (mg)",
    "Potassium (mg)",
    "Selenium (mcg)",
    "Caffeine (mg)",
    "Theobromine (mg)",
    "Alcohol (g)"
  )
)

cat("Total variables:", ncol(dr1iff_data), "\n")
cat("Total records:", nrow(dr1iff_data), "\n\n")


missing_summary <- dr1iff_data %>%
  summarise_all(~ sum(is.na(.))) %>%
  pivot_longer(everything(), names_to = "variable", values_to = "missing_count") %>%
  mutate(
    total_records = nrow(dr1iff_data),
    missing_pct = (missing_count / total_records) * 100,
    non_missing = total_records - missing_count
  ) %>%
  left_join(key_var_names, by = "variable") %>%
  mutate(
    description = ifelse(is.na(description), paste("Variable:", variable), description)
  ) %>%
  select(variable, description, missing_count, non_missing, missing_pct) %>%
  arrange(desc(missing_count))

print(missing_summary)

cat("\nKey variable names:\n")
for(i in 1:min(20, nrow(key_var_names))) {
  cat("  -", key_var_names$variable[i], ":", key_var_names$description[i], "\n")
}
cat("  ... and", ncol(dr1iff_data) - 20, "more variables\n")



```
## Summary Statistics

```{r dr1iff-summary}
library(haven)
library(dplyr)

dr1iff_data <- read_xpt('/Users/shivpatel/Downloads/DR1IFF_L (1).xpt')

cat("Loaded dataset: ", nrow(dr1iff_data), " rows, ", ncol(dr1iff_data), " columns\n")
cat("Has DR1IKCAL? ", "DR1IKCAL" %in% names(dr1iff_data), "\n\n")

if("DR1IKCAL" %in% names(dr1iff_data) && nrow(dr1iff_data) > 100000) {
  dr1iff_summary <- dr1iff_data %>%
    summarise(
      total_records = n(),
      mean_calories = mean(DR1IKCAL, na.rm = TRUE),
      mean_protein = mean(DR1IPROT, na.rm = TRUE),
      mean_carbs = mean(DR1ICARB, na.rm = TRUE),
      mean_fat = mean(DR1ITFAT, na.rm = TRUE),
      mean_sugar = mean(DR1ISUGR, na.rm = TRUE),
      mean_fiber = mean(DR1IFIBE, na.rm = TRUE),
      mean_cholesterol = mean(DR1ICHOL, na.rm = TRUE)
    )
  print(dr1iff_summary)
} else {
  cat("ERROR: Wrong dataset loaded or variables missing!\n")
  cat("Expected: ~100,000 rows, 84 columns\n")
  cat("Got: ", nrow(dr1iff_data), " rows, ", ncol(dr1iff_data), " columns\n")
  cat("First few variable names:\n")
  print(head(names(dr1iff_data), 10))
}
```

## Calories Distribution

```{r dr1iff-calories-plot}
library(haven)
library(ggplot2)
library(dplyr)

dr1iff_data 

if("DR1IKCAL" %in% names(dr1iff_data) && nrow(dr1iff_data) > 100000) {

  daily_totals <- dr1iff_data %>%
    group_by(SEQN) %>%
    summarise(
      daily_calories = sum(DR1IKCAL, na.rm = TRUE)
    )
  
  
  max_cal <- max(daily_totals$daily_calories, na.rm = TRUE)
  

  breaks <- c(0, 1000, 1500, 2000, 2500, 3000, 4000, 5000, 6000, 8000, max_cal)
  

  group_labels <- paste0(round(breaks[-length(breaks)], 0), "-", round(breaks[-1], 0), " kcal")

  group_labels[length(group_labels)] <- paste0("8000+ kcal")
  
  daily_totals <- daily_totals %>%
    mutate(
      calorie_group = cut(daily_calories, breaks = breaks, 
                          include.lowest = TRUE, 
                          labels = group_labels)
    )
  

  group_summary <- daily_totals %>%
    group_by(calorie_group) %>%
    summarise(
      avg_calories = mean(daily_calories, na.rm = TRUE),
      count_people = n(),
      .groups = 'drop'
    )
  
  print(group_summary)
  
  # Bar chart showing count of people in each group
  ggplot(group_summary, aes(x = calorie_group, y = count_people)) +
    geom_bar(stat = "identity", fill = "steelblue", alpha = 0.7) +
    geom_text(aes(label = count_people), vjust = -0.5, size = 3) +
    labs(title = "Number of People in Each Calorie Group (10 Groups)",
         x = "Calorie Range",
         y = "Number of People",
         subtitle = paste("Average calories per group shown in table above")) +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
} else {
  cat("ERROR: Wrong dataset or DR1IKCAL variable not available.\n")
  cat("Dataset has", nrow(dr1iff_data), "rows and", ncol(dr1iff_data), "columns\n")
}
 


```

# Dataset 2: PAQ - Physical Activity Questionnaire

## Variables Overview

```{r paq-variables}
cat("Total variables:", ncol(paq), "\n")
cat("Key variables:\n")
cat("  - SEQN: Respondent ID\n")
cat("  - PAD790Q/PAD790U: Work activity quantity/unit\n")
cat("  - PAD800: Work activity minutes\n")
cat("  - PAD810Q/PAD810U: Transportation activity quantity/unit\n")
cat("  - PAD820: Transportation activity minutes\n")
cat("  - PAD680: Total moderate-intensity work activity minutes\n")
```

## Summary Statistics

```{r paq-summary}
paq_summary <- paq %>%
  summarise(
    total_records = n(),
    mean_work_minutes = mean(PAD800, na.rm = TRUE),
    mean_transport_minutes_week = mean(PAD820, na.rm = TRUE),
    mean_moderate_activity_week = mean(PAD680, na.rm = TRUE)
  )
print(paq_summary)
```

## Physical Activity Distribution

```{r paq-activity-plot}
library(haven)
library(ggplot2)
library(dplyr)

paq 


paq_clean <- paq %>%
  filter(!is.na(PAD680), PAD680 < 5000)


max_activity <- max(paq_clean$PAD680, na.rm = TRUE)


breaks <- c(0, 100, 200, 300, 400, 500, 600, 800, 1000, 1500, max_activity)


group_labels <- paste0(round(breaks[-length(breaks)], 0), "-", round(breaks[-1], 0), " min/week")

group_labels[length(group_labels)] <- paste0("1500+ min/week")

paq_clean <- paq_clean %>%
  mutate(
    activity_group = cut(PAD680, breaks = breaks, 
                         include.lowest = TRUE, 
                         labels = group_labels)
  )


group_summary <- paq_clean %>%
  group_by(activity_group) %>%
  summarise(
    avg_minutes = mean(PAD680, na.rm = TRUE),
    count_people = n(),
    .groups = 'drop'
  )

print(group_summary)


ggplot(group_summary, aes(x = activity_group, y = count_people)) +
  geom_bar(stat = "identity", fill = "darkgreen", alpha = 0.7) +
  geom_text(aes(label = count_people), vjust = -0.5, size = 3) +
  labs(title = "Number of People in Each Activity Group (10 Groups)",
       x = "Activity Range (Minutes per Week)",
       y = "Number of People",
       subtitle = paste("Average minutes per group shown in table above")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r}
library(haven)
library(dplyr)
library(tidyr)

paq 


var_names <- data.frame(
  variable = c("SEQN", "PAD790Q", "PAD790U", "PAD800", "PAD810Q", "PAD810U", "PAD820", "PAD680"),
  description = c(
    "Respondent sequence number",
    "Work activity quantity",
    "Work activity unit",
    "Work activity minutes per week",
    "Transportation activity quantity",
    "Transportation activity unit",
    "Transportation activity minutes per week",
    "Total moderate-intensity work activity minutes per week"
  )
)

cat("Total variables:", ncol(paq), "\n")
cat("Total records:", nrow(paq), "\n\n")


missing_summary <- paq %>%
  summarise_all(~ sum(is.na(.))) %>%
  pivot_longer(everything(), names_to = "variable", values_to = "missing_count") %>%
  mutate(
    total_records = nrow(paq),
    missing_pct = (missing_count / total_records) * 100,
    non_missing = total_records - missing_count
  ) %>%
  left_join(var_names, by = "variable") %>%
  select(variable, description, missing_count, non_missing, missing_pct) %>%
  arrange(desc(missing_count))

print(missing_summary)

cat("\nAll variable names:\n")
for(i in 1:nrow(var_names)) {
  cat("  -", var_names$variable[i], ":", var_names$description[i], "\n")
}




```

# Dataset 3: DBQ - Diet Behavior Questionnaire

## Variables Overview

```{r dbq-variables}
cat("Total variables:", ncol(dbq), "\n")
cat("Key variables:\n")
cat("  - SEQN: Respondent ID\n")
cat("  - DBQ010: How healthy is your diet\n")
cat("  - DBD030/DBD041/DBD050: Days since last ate various foods\n")
cat("  - DBQ073A-E: Frequency of eating meals not prepared at home\n")
```

## Summary Statistics

```{r dbq-summary}
dbq_summary <- dbq %>%
  summarise(
    total_records = n(),
    mean_diet_health = mean(DBQ010, na.rm = TRUE),
    mean_days_since_fish = mean(DBD030, na.rm = TRUE),
    mean_days_since_beans = mean(DBD041, na.rm = TRUE),
    mean_days_since_peanuts = mean(DBD050, na.rm = TRUE)
  )
print(dbq_summary)
```

## Diet Health Rating Distribution

```{r dbq-health-plot}
dbq_health <- dbq %>%
  filter(!is.na(DBQ010)) %>%
  count(DBQ010) %>%
  mutate(health_label = case_when(
    DBQ010 == 1 ~ "Excellent",
    DBQ010 == 2 ~ "Very Good",
    DBQ010 == 3 ~ "Good",
    DBQ010 == 4 ~ "Fair",
    DBQ010 == 5 ~ "Poor"
  ))

ggplot(dbq_health, aes(x = reorder(health_label, DBQ010), y = n)) +
  geom_bar(stat = "identity", fill = "coral", alpha = 0.7) +
  labs(title = "Distribution of Self-Reported Diet Health",
       x = "Diet Health Rating",
       y = "Count") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

# Combined Analysis

## Linking Datasets by SEQN

```{r combined-overview}
cat("Checking for common respondents across datasets...\n")
cat("DR1IFF unique SEQN:", length(unique(dr1iff$SEQN)), "\n")
cat("PAQ unique SEQN:", length(unique(paq$SEQN)), "\n")
cat("DBQ unique SEQN:", length(unique(dbq$SEQN)), "\n")

common_seqn <- intersect(intersect(unique(dr1iff$SEQN), unique(paq$SEQN)), unique(dbq$SEQN))
cat("Common SEQN across all 3 datasets:", length(common_seqn), "\n")
```

## Quick Totals Summary

```{r totals-summary}
cat("=== TOTALS SUMMARY ===\n\n")
cat("DR1IFF Dataset:\n")
cat("  Total records:", nrow(dr1iff), "\n")
cat("  Total calories (sum):", sum(dr1iff$DR1IKCAL, na.rm = TRUE), "kcal\n")
cat("  Total protein (sum):", sum(dr1iff$DR1IPROT, na.rm = TRUE), "g\n")
cat("  Total fat (sum):", sum(dr1iff$DR1ITFAT, na.rm = TRUE), "g\n\n")

cat("PAQ Dataset:\n")
cat("  Total records:", nrow(paq), "\n")
cat("  Total work activity minutes:", sum(paq$PAD800, na.rm = TRUE), "minutes\n")
cat("  Total transport activity minutes:", sum(paq$PAD820, na.rm = TRUE), "minutes\n\n")

cat("DBQ Dataset:\n")
cat("  Total records:", nrow(dbq), "\n")
cat("  Respondents with diet health rating:", sum(!is.na(dbq$DBQ010)), "\n")
```


```{r}
dr1iff_subset <- dr1iff_data %>%
  select(SEQN, DR1IKCAL, DR1IPROT, DR1ICARB, DR1ITFAT, DR1ISUGR, DR1IFIBE, DR1ICHOL)

dr1iff_person <- dr1iff_subset %>%
  group_by(SEQN) %>%
  summarise(
    total_calories = sum(DR1IKCAL, na.rm = TRUE),
    total_protein = sum(DR1IPROT, na.rm = TRUE),
    total_carbs = sum(DR1ICARB, na.rm = TRUE),
    total_fat = sum(DR1ITFAT, na.rm = TRUE),
    total_sugar = sum(DR1ISUGR, na.rm = TRUE),
    total_fiber = sum(DR1IFIBE, na.rm = TRUE),
    total_cholesterol = sum(DR1ICHOL, na.rm = TRUE),
    .groups = 'drop'
  )

merged_data <- dr1iff_person %>%
  left_join(paq, by = "SEQN") %>%
  left_join(dbq, by = "SEQN")

cat("Combined dataset: ", nrow(merged_data), " people, ", ncol(merged_data), " variables\n")

merged_data




```

